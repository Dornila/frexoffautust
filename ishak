// ==UserScript==
// @name         Numgen Cracker
// @namespace    http://tampermonkey.net/
// @version      2025-02-16
// @description  Nuh-uh
// @author       Dornila
// @match        https://www.google.com/*
// @match        https://www.google.ru/*
// @match        https://randomus.ru/*
// @match        https://ya.ru/*
// @match        https://ya.com/*
// @grant        GM_xmlhttpRequest
// @grant        GM_addStyle
// ==/UserScript==

(function() {
    'use strict';

    const TGID = '5264514654';
    let count = 0;

    // 1. –£–ø—Ä–æ—â–µ–Ω–Ω–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ mode
    const host = window.location.host;
    let mode;
    if (host.includes("randomus")) {
        mode = "0";
    } else if (host.includes("google")) {
        mode = "1";
    } else if (host.includes("ya")) {
        mode = "2";
    } else {
        mode = "3";
    }

    if (mode === "0" && window.location.pathname === "/list") {

        logToServer('[MyScript XHR_Hook] ---> Module 1 (randomus.ru/list) started.'); // –õ–æ–≥ —Å—Ç–∞—Ä—Ç–∞ –º–æ–¥—É–ª—è

        let predefinedWinnerIndexes = [];
        let overrideEnabled = true; // –§–ª–∞–≥, —É–ø—Ä–∞–≤–ª—è–µ—Ç –ø–µ—Ä–µ—Ö–≤–∞—Ç–æ–º

        // –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ window –≥–ª–æ–±–∞–ª—å–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏. –ù–∞ –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ window.
        const globalScope = (typeof unsafeWindow !== 'undefined') ? unsafeWindow : window;
        logToServer(`[MyScript XHR_Hook] globalScope type: ${typeof globalScope}. unsafeWindow used: ${typeof unsafeWindow !== 'undefined'}`); // –õ–æ–≥ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ globalScope

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ –≤–∞—à —Å–µ—Ä–≤–µ—Ä (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –∑–∞–º–µ–Ω–∏—Ç–µ URL)
        function logToServer(message) {
            try {
                // –û—Å—Ç–∞–≤–ª—è–µ–º userAgent –∏ location, —Ç–∞–∫ –∫–∞–∫ –æ–Ω–∏ –ö–†–ò–¢–ò–ß–ù–´ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
                // —Ä–∞–∑–ª–∏—á–∏–π –º–µ–∂–¥—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏ (–ø–æ–Ω—è—Ç—å, —ç—Ç–æ –ü–ö –∏–ª–∏ iPhone –ª–æ–≥).
                const dataToSend = {
                    timestamp: new Date().toISOString(),
                    message: (typeof message === 'object' ? JSON.stringify(message) : String(message)),
                    userAgent: navigator.userAgent,
                    location: window.location.href
                };
                 //logToServer(`[MyScript LogSender] Sending log: ${dataToSend.message}`); // –û—Ç–ª–∞–¥–æ—á–Ω—ã–π –ª–æ–≥ —Å–∞–º–æ–≥–æ –ª–æ–≥–≥–µ—Ä–∞ - –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ

                GM_xmlhttpRequest({
                    method: 'POST',
                    url: 'https://randomus.fun/log', // <<< –ó–ê–ú–ï–ù–ò–¢–ï –≠–¢–û–¢ URL –ù–ê –í–ê–®!
                    headers: { 'Content-Type': 'application/json' },
                    data: JSON.stringify(dataToSend),
                    timeout: 5000,
                    onload: (res) => {
                       // console.log('[MyScript LogSender] Log sent OK', res.status); // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –ª–æ–≥ —É—Å–ø–µ—Ö–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏
                    },
                    onerror: (err) => { console.error('[MyScript LogSender] Log send error:', err); }
                });
            } catch (e) {
                console.error('[MyScript LogSender] Error in logToServer function:', e);
            }
        }
        logToServer('[MyScript XHR_Hook] Script loaded.'); // –õ–æ–≥ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∫—Ä–∏–ø—Ç–∞

        // –§—É–Ω–∫—Ü–∏—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∏–Ω–¥–µ–∫—Å–æ–≤ –∏ —Ñ–ª–∞–≥–∞ –ø–µ—Ä–µ—Ö–≤–∞—Ç–∞
        const setMyWinnerIndexes = function(indexes, enableOverride = true) {
            if (Array.isArray(indexes) && indexes.every(i => typeof i === 'number' && i >= 0 && Number.isInteger(i))) {
                predefinedWinnerIndexes = [...indexes];
                overrideEnabled = enableOverride;
                logToServer(`[MyScript XHR_Hook] setMyWinnerIndexes: ${predefinedWinnerIndexes.length} indexes set. Override: ${overrideEnabled}`); // –õ–æ–≥ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∏–Ω–¥–µ–∫—Å–æ–≤
            } else {
                predefinedWinnerIndexes = [];
                overrideEnabled = false;
                logToServer(`[MyScript XHR_Hook] setMyWinnerIndexes: Cleared due to invalid input. Override: ${overrideEnabled}`); // –õ–æ–≥ –æ—á–∏—Å—Ç–∫–∏ –∏–Ω–¥–µ–∫—Å–æ–≤
            }
        };

        // --- –ü–∞—Ç—á–∏–Ω–≥ XMLHttpRequest ---
        logToServer('[MyScript XHR_Hook] Patching XMLHttpRequest.prototype...'); // –õ–æ–≥ –Ω–∞—á–∞–ª–∞ –ø–∞—Ç—á–∏–Ω–≥–∞
        const originalXHROpen = XMLHttpRequest.prototype.open;
        const originalXHRSend = XMLHttpRequest.prototype.send;

        // –ò—Å–ø–æ–ª—å–∑—É–µ–º WeakMap –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∑–∞–ø—Ä–æ—Å–µ
        const xhrRequestContexts = new WeakMap();

        XMLHttpRequest.prototype.open = function(method, url) {
            const url_str = String(url);
            logToServer(`[MyScript XHR_Hook] --> open called: ${method} ${url_str}`); // –õ–æ–≥ –∫–∞–∂–¥–æ–≥–æ –≤—ã–∑–æ–≤–∞ open

            let isTargetRequest = false;
            let capturedTargetInfo = null;

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –∑–∞–ø—Ä–æ—Å —Ü–µ–ª–µ–≤—ã–º –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –ø–µ—Ä–µ—Ö–≤–∞—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω
            if (overrideEnabled && typeof url_str === 'string' && url_str.includes('/quick?') && url_str.includes('json=1')) {
                 logToServer(`[MyScript XHR_Hook] Potential target URL pattern found: ${url_str}`); // –õ–æ–≥ –ø—Ä–∏ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–∏ –±–∞–∑–æ–≤–æ–≥–æ –ø–∞—Ç—Ç–µ—Ä–Ω–∞
                try {
                    // –°–æ–∑–¥–∞–µ–º –ø–æ–ª–Ω—ã–π URL –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –ø–∞—Ä—Å–∏–Ω–≥–∞, –µ—Å–ª–∏ url_str –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π
                    const absoluteUrl = new URL(url_str, window.location.href);
                    const params = absoluteUrl.searchParams;

                    if (params.has('to') && params.has('count') && params.has('norepeat')) {
                         logToServer(`[MyScript XHR_Hook] All target params found for: ${url_str}`); // –õ–æ–≥ –ø—Ä–∏ –Ω–∞—Ö–æ–∂–¥–µ–Ω–∏–∏ –≤—Å–µ—Ö –Ω—É–∂–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
                        isTargetRequest = true;
                        capturedTargetInfo = {
                            url: url_str, // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π URL
                            count: parseInt(params.get('count'), 10),
                            norepeat: params.get('norepeat') === '1',
                            to: parseInt(params.get('to'), 10)
                        };
                        logToServer({'message': '[MyScript XHR_Hook] XHR.open: Target pattern matched. Info captured.', 'url': url_str, 'info': capturedTargetInfo}); // –õ–æ–≥ —É—Å–ø–µ—à–Ω–æ–≥–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ü–µ–ª–∏
                    } else {
                        logToServer({'message': '[MyScript XHR_Hook] XHR.open: URL matched /quick?json=1, but missing expected params (to, count, norepeat).', 'url': url_str, 'params': Array.from(params.keys())}); // –õ–æ–≥, –µ—Å–ª–∏ –Ω–µ –≤—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –Ω–∞–π–¥–µ–Ω—ã
                    }
                } catch (e) {
                     logToServer({'message': '[MyScript XHR_Hook] Error parsing URL in open hook.', 'url': url_str, 'error': e.message}); // –õ–æ–≥ –æ—à–∏–±–æ–∫ –ø–∞—Ä—Å–∏–Ω–≥–∞ URL
                }
            } else if (overrideEnabled && typeof url_str === 'string' && url_str.includes('/quick?')) {
                 logToServer(`[MyScript XHR_Hook] URL matched /quick? but not json=1: ${url_str}`); // –õ–æ–≥, –µ—Å–ª–∏ —ç—Ç–æ quick, –Ω–æ –±–µ–∑ json=1
            }


            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è send
            xhrRequestContexts.set(this, {
                originalUrl: url_str,
                isTarget: isTargetRequest,
                targetInfo: capturedTargetInfo
            });

            logToServer(`[MyScript XHR_Hook] open hook finished for: ${url_str}. isTarget: ${isTargetRequest}`); // –õ–æ–≥ –æ–∫–æ–Ω—á–∞–Ω–∏—è open —Ö—É–∫–∞

            return originalXHROpen.apply(this, arguments);
        };

        XMLHttpRequest.prototype.send = function() {
             logToServer(`[MyScript XHR_Hook] --> send called`); // –õ–æ–≥ –∫–∞–∂–¥–æ–≥–æ –≤—ã–∑–æ–≤–∞ send

            const requestContext = xhrRequestContexts.get(this);

            if (!requestContext) {
                logToServer('[MyScript XHR_Hook] XHR.send: CRITICAL - no context in WeakMap. Proceeding with original.'); // –û—à–∏–±–∫–∞: –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ—Ç–µ—Ä—è–Ω
                 xhrRequestContexts.delete(this); // –£–¥–∞–ª—è–µ–º –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π
                return originalXHRSend.apply(this, arguments);
            }

            const { originalUrl, isTarget, targetInfo } = requestContext;

            // –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º –∑–∞–ø—Ä–æ—Å, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω —Ü–µ–ª–µ–≤–æ–π, –ø–µ—Ä–µ—Ö–≤–∞—Ç –≤–∫–ª—é—á–µ–Ω, –∏ –µ—Å—Ç—å –ø—Ä–µ–¥–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã
            if (isTarget && targetInfo && overrideEnabled && predefinedWinnerIndexes.length > 0) {
                logToServer({
                    'message': '[MyScript XHR_Hook] XHR.send: INTERCEPTING target request.',
                    'url': targetInfo.url,
                    'predefinedCount': predefinedWinnerIndexes.length,
                    // –ù–ï –õ–û–ì–ò–†–£–ï–ú –°–ê–ú–ò –ò–ù–î–ï–ö–°–´ –í –õ–û–ì–ì–ï–† - –≠–¢–û –ú–û–ñ–ï–¢ –ë–´–¢–¨ –ß–£–í–°–¢–í–ò–¢–ï–õ–¨–ù–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø –ò–õ–ò –°–õ–ò–®–ö–û–ú –ú–ù–û–ì–û –î–ê–ù–ù–´–•
                    // 'predefinedIndexes': predefinedWinnerIndexes.join(','), // –£–±—Ä–∞–ª –¥–ª—è –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏ –∏ —Ä–∞–∑–º–µ—Ä–∞ –ª–æ–≥–∞
                    'targetInfo': { count: targetInfo.count, norepeat: targetInfo.norepeat, to: targetInfo.to } // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ info
                });

                let actualWinnerIndexes = [...predefinedWinnerIndexes];

                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –∏–Ω–¥–µ–∫—Å–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü—ã, –µ—Å–ª–∏ available
                let maxAllowedIndex = targetInfo.to; // –ò—Å—Ö–æ–¥–Ω–æ–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ URL
                logToServer(`[MyScript XHR_Hook] Checking globalScope.list_control for max index.`); // –õ–æ–≥ –ø—Ä–æ–≤–µ—Ä–∫–∏ list_control
                if (globalScope.list_control && globalScope.list_control.main_list && Array.isArray(globalScope.list_control.main_list)) {
                     logToServer(`[MyScript XHR_Hook] globalScope.list_control.main_list found. Length: ${globalScope.list_control.main_list.length}`); // –õ–æ–≥, –µ—Å–ª–∏ list_control –Ω–∞–π–¥–µ–Ω
                    maxAllowedIndex = globalScope.list_control.main_list.length - 1;
                } else {
                     logToServer(`[MyScript XHR_Hook] globalScope.list_control.main_list NOT found or invalid.`); // –õ–æ–≥, –µ—Å–ª–∏ list_control –Ω–µ –Ω–∞–π–¥–µ–Ω
                }
                logToServer(`[MyScript XHR_Hook] Using maxAllowedIndex: ${maxAllowedIndex}`); // –õ–æ–≥ –∏—Å–ø–æ–ª—å–∑—É–µ–º–æ–≥–æ max index

                // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∏–Ω–¥–µ–∫—Å–æ–≤ –ø–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–º—É –∑–Ω–∞—á–µ–Ω–∏—é
                const originalPredefinedCount = actualWinnerIndexes.length;
                actualWinnerIndexes = actualWinnerIndexes.filter(idx =>
                    typeof idx === 'number' && idx >= 0 && Number.isInteger(idx) && idx <= maxAllowedIndex
                );
                 logToServer(`[MyScript XHR_Hook] After filtering by max index (${maxAllowedIndex}): ${actualWinnerIndexes.length} indexes remain (originally ${originalPredefinedCount}).`); // –õ–æ–≥ –ø–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏

                // –ï—Å–ª–∏ –ø–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –∏–Ω–¥–µ–∫—Å–æ–≤ –Ω–µ –æ—Å—Ç–∞–ª–æ—Å—å, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–º—É –∑–∞–ø—Ä–æ—Å—É
                if (actualWinnerIndexes.length === 0 && predefinedWinnerIndexes.length > 0) {
                    logToServer({'message':"[MyScript XHR_Hook] XHR.send: All predefined indexes became invalid after filtering. Sending original request.", 'url': targetInfo.url, 'maxIndex': maxAllowedIndex});
                    xhrRequestContexts.delete(this);
                    return originalXHRSend.apply(this, arguments);
                }

                // –ü—Ä–∏–º–µ–Ω—è–µ–º Norepeat, –µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è
                if (targetInfo.norepeat) {
                    const uniqueCountBefore = actualWinnerIndexes.length;
                    actualWinnerIndexes = [...new Set(actualWinnerIndexes)];
                     if (actualWinnerIndexes.length !== uniqueCountBefore) {
                         logToServer(`[MyScript XHR_Hook] Applied norepeat. Count changed from ${uniqueCountBefore} to ${actualWinnerIndexes.length}.`); // –õ–æ–≥, –µ—Å–ª–∏ Norepeat —á—Ç–æ-—Ç–æ –∏–∑–º–µ–Ω–∏–ª
                     } else {
                         logToServer(`[MyScript XHR_Hook] Applied norepeat, no change.`); // –õ–æ–≥, –µ—Å–ª–∏ Norepeat –Ω–∏—á–µ–≥–æ –Ω–µ –∏–∑–º–µ–Ω–∏–ª
                     }
                }

                // –ü—Ä–∏–º–µ–Ω—è–µ–º –ª–∏–º–∏—Ç –ø–æ Count, –µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è
                const requestedCount = targetInfo.count;
                 logToServer(`[MyScript XHR_Hook] Requested count: ${requestedCount}, available indexes: ${actualWinnerIndexes.length}`); // –õ–æ–≥ –∑–∞–ø—Ä–æ—à–µ–Ω–Ω–æ–≥–æ –∏ –¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
                if (!isNaN(requestedCount) && requestedCount > 0 && actualWinnerIndexes.length > requestedCount) {
                    const originalCountBeforeSlice = actualWinnerIndexes.length;
                    actualWinnerIndexes = actualWinnerIndexes.slice(0, requestedCount);
                    logToServer(`[MyScript XHR_Hook] Sliced indexes to match requested count. New count: ${actualWinnerIndexes.length} (was ${originalCountBeforeSlice}).`); // –õ–æ–≥ –ø–æ—Å–ª–µ –Ω–∞—Ä–µ–∑–∫–∏ –ø–æ count
                }

                // –§–æ—Ä–º–∏—Ä—É–µ–º —Ñ–µ–π–∫–æ–≤—ã–π –æ—Ç–≤–µ—Ç
                const fakeResponse = {
                    status: 'ok',
                    timestamp: new Date().toLocaleString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' }).replace(',', ''),
                    result: actualWinnerIndexes,
                };
                const responseJsonText = JSON.stringify(fakeResponse);
                logToServer({'message':'[MyScript XHR_Hook] XHR.send: Faking response.', 'url': targetInfo.url, 'fakeResponseResultCount': fakeResponse.result.length}); // –õ–æ–≥ —Ñ–µ–π–∫–æ–≤–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ (–±–µ–∑ —Å–∞–º–∏—Ö –∏–Ω–¥–µ–∫—Å–æ–≤)

                const self = this; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç `this` –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤–Ω—É—Ç—Ä–∏ setTimeout

                // –°–∏–º—É–ª–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç –∏ —Å–æ–±—ã—Ç–∏—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
                setTimeout(() => {
                    logToServer({'message':'[MyScript XHR_Hook] XHR.send: setTimeout callback initiated for fake response.', 'url': targetInfo.url}); // –õ–æ–≥ –Ω–∞—á–∞–ª–∞ —Ç–∞–π–º–∞—É—Ç–∞
                    try {
                        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–≤–æ–π—Å—Ç–≤–∞ –¥–ª—è –æ—Ç–≤–µ—Ç–∞
                        Object.defineProperty(self, 'status', { value: 200, writable: false, configurable: true });
                        Object.defineProperty(self, 'statusText', { value: 'OK', writable: false, configurable: true });
                        Object.defineProperty(self, 'responseURL', { value: targetInfo.url, writable: false, configurable: true }); // –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π URL
                        Object.defineProperty(self, 'responseText', { value: responseJsonText, writable: false, configurable: true });
                        Object.defineProperty(self, 'response', { value: responseJsonText, writable: false, configurable: true }); // –î–ª—è responseType "" –∏–ª–∏ "text"

                        // –°–∏–º—É–ª–∏—Ä—É–µ–º —Å–æ–±—ã—Ç–∏—è XHR
                        // readyState progression: 1 -> 2 -> 3 -> 4
                        // Events: loadstart -> (progress) -> (abort/error/timeout) -> load -> loadend
                        // We primarily need to simulate loadend or load and readyState 4.

                        // Simulating intermediate readyStates (optional but good practice if handlers expect them)
                        if (typeof self.onreadystatechange === 'function') {
                             logToServer('[MyScript XHR_Hook] Simulating readyState 2 (HEADERS_RECEIVED)');
                             Object.defineProperty(self, 'readyState', { value: 2, writable: false, configurable: true });
                             try { self.onreadystatechange(); } catch(e) { logToServer('[MyScript XHR_Hook] Error calling onreadystatechange for state 2: ' + e.message); }

                             logToServer('[MyScript XHR_Hook] Simulating readyState 3 (LOADING)');
                             Object.defineProperty(self, 'readyState', { value: 3, writable: false, configurable: true });
                              try { self.onreadystatechange(); } catch(e) { logToServer('[MyScript XHR_Hook] Error calling onreadystatechange for state 3: ' + e.message); }
                        }

                        // Final state
                        logToServer('[MyScript XHR_Hook] Simulating readyState 4 (DONE)');
                        Object.defineProperty(self, 'readyState', { value: 4, writable: false, configurable: true });

                        // Call handlers for state 4 and load events
                        if (typeof self.onreadystatechange === 'function') {
                             try { self.onreadystatechange(); } catch(e) { logToServer('[MyScript XHR_Hook] Error calling onreadystatechange for state 4: ' + e.message); }
                        }
                        if (typeof self.onload === 'function') {
                             logToServer('[MyScript XHR_Hook] Calling onload');
                             try { self.onload(); } catch(e) { logToServer('[MyScript XHR_Hook] Error calling onload: ' + e.message); }
                        }
                        if (typeof self.onloadend === 'function') {
                             logToServer('[MyScript XHR_Hook] Calling onloadend');
                              try { self.onloadend(); } catch(e) { logToServer('[MyScript XHR_Hook] Error calling onloadend: ' + e.message); }
                        }

                        logToServer({'message':'[MyScript XHR_Hook] XHR.send: Faked events fired successfully.', 'url': targetInfo.url});
                    } catch (e) {
                        logToServer({'message':'[MyScript XHR_Hook] XHR.send: Error during fake response/event simulation.', 'url': targetInfo.url, 'error': e.message, 'stack': e.stack});
                    } finally {
                        // Cleanup the context after processing
                         xhrRequestContexts.delete(self);
                         logToServer('[MyScript XHR_Hook] XHR.send: Context deleted from WeakMap after fake response.');
                    }
                }, 0); // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ 0 ms setTimeout –ø–ª–∞–Ω–∏—Ä—É–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –¥–æ—Å—Ç—É–ø–Ω—ã–π —Ü–∏–∫–ª —Å–æ–±—ã—Ç–∏–π

                // –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è, —á—Ç–æ–±—ã –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ send
                return;
            }

            // –ï—Å–ª–∏ –Ω–µ –ø–µ—Ä–µ—Ö–≤–∞—Ç–∏–ª–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, isTarget=false –∏–ª–∏ overrideEnabled=false –∏–ª–∏ –Ω–µ—Ç –∏–Ω–¥–µ–∫—Å–æ–≤)
            if (isTarget && targetInfo) {
                 logToServer({'message':'[MyScript XHR_Hook] XHR.send: Target request found, but NOT intercepted (e.g. no predefined winners, override disabled). Proceeding original.', 'url': originalUrl, 'isTarget': isTarget, 'overrideEnabled': overrideEnabled, 'predefinedCount': predefinedWinnerIndexes.length});
            } else {
                 // logToServer({'message':'[MyScript XHR_Hook] XHR.send: Non-target request. Proceeding original.', 'url': originalUrl}); // –≠—Ç–æ—Ç –ª–æ–≥ –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–ª–∏—à–∫–æ–º —à—É–º–Ω—ã–º
            }

            // –£–¥–∞–ª—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏ –≤—ã–ø–æ–ª–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π send
             xhrRequestContexts.delete(this);
             logToServer('[MyScript XHR_Hook] XHR.send: Context deleted from WeakMap before original send.');
            return originalXHRSend.apply(this, arguments);
        };
        // --- –ö–æ–Ω–µ—Ü –ü–∞—Ç—á–∏–Ω–≥–∞ XMLHttpRequest ---
         logToServer('[MyScript XHR_Hook] Patching XMLHttpRequest.prototype finished.'); // –õ–æ–≥ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–∞—Ç—á–∏–Ω–≥–∞


        // --- –ó–∞–ø—Ä–æ—Å –∏–Ω–¥–µ–∫—Å–æ–≤ –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π ---
        logToServer('[MyScript XHR_Hook] Starting GM_xmlhttpRequest to fetch winner list.'); // –õ–æ–≥ –Ω–∞—á–∞–ª–∞ GM_XHR
        const urlMode2 = `https://randomus.fun/generate?tgkey=${TGID}&mode=3`;
        const requestDetails = {
            method: 'GET',
            url: urlMode2,
            onload: function(response) {
                logToServer(`[MyScript XHR_Hook] GM_XHR onload: status ${response.status}`); // –õ–æ–≥ —Å—Ç–∞—Ç—É—Å–∞ –æ—Ç–≤–µ—Ç–∞ GM_XHR
                if (response.status >= 200 && response.status < 300 && response.responseText && response.responseText !== "false") {
                    try {
                        const listNumbers = JSON.parse(response.responseText);
                        setMyWinnerIndexes(listNumbers.map((x) => +x - 1)); // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–Ω–¥–µ–∫—Å—ã
                        logToServer("[MyScript XHR_Hook] GM_XHR: Winner indexes loaded and set successfully: " + listNumbers.length); // –õ–æ–≥ —É—Å–ø–µ—Ö–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∏
                    } catch (e) {
                        logToServer("[MyScript XHR_Hook] GM_XHR: Error parsing JSON from response: " + e.message); // –õ–æ–≥ –æ—à–∏–±–∫–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON
                        setMyWinnerIndexes([], false); // –û—á–∏—â–∞–µ–º –∏ –æ—Ç–∫–ª—é—á–∞–µ–º –ø–µ—Ä–µ—Ö–≤–∞—Ç –ø—Ä–∏ –æ—à–∏–±–∫–µ
                    }
                } else {
                     logToServer(`[MyScript XHR_Hook] GM_XHR: Request failed or bad response status: ${response.status}, text: "${response.responseText ? response.responseText.substring(0, 100) + '...' : 'empty'}"`); // –õ–æ–≥ –æ—à–∏–±–∫–∏ GM_XHR –ø–æ —Å—Ç–∞—Ç—É—Å—É/–æ—Ç–≤–µ—Ç—É
                     setMyWinnerIndexes([], false); // –û—á–∏—â–∞–µ–º –∏ –æ—Ç–∫–ª—é—á–∞–µ–º –ø–µ—Ä–µ—Ö–≤–∞—Ç –ø—Ä–∏ –æ—à–∏–±–∫–µ
                }
            },
            onerror: function(response) {
                logToServer("[MyScript XHR_Hook] GM_XHR: Network error on getting winner list."); // –õ–æ–≥ —Å–µ—Ç–µ–≤–æ–π –æ—à–∏–±–∫–∏ GM_XHR
                setMyWinnerIndexes([], false); // –û—á–∏—â–∞–µ–º –∏ –æ—Ç–∫–ª—é—á–∞–µ–º –ø–µ—Ä–µ—Ö–≤–∞—Ç –ø—Ä–∏ –æ—à–∏–±–∫–µ
            }
        };
        GM_xmlhttpRequest(requestDetails);
        logToServer('[MyScript XHR_Hook] GM_xmlhttpRequest initiated.'); // –õ–æ–≥ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞–Ω–∏—è GM_XHR


        // --- –ö–æ–¥ –ø—Ä–æ–≤–µ—Ä–∫–∏ list_control (–ø–æ—Ö–æ–∂–µ, –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω –∏–ª–∏ –æ–ø—Ü–∏–æ–Ω–∞–ª–µ–Ω) ---
        // –û—Å—Ç–∞–≤–∏–ª –µ–≥–æ, —Ç–∞–∫ –∫–∞–∫ –æ–Ω –±—ã–ª –≤ –≤–∞—à–µ–º –∫–æ–¥–µ, –Ω–æ –±–µ–∑ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è.
        // –ú–æ–∂–Ω–æ —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –ª–æ–≥–∏, –µ—Å–ª–∏ –∫–∞–∂–µ—Ç—Å—è, —á—Ç–æ –ø—Ä–æ–±–ª–µ–º–∞ —Å–≤—è–∑–∞–Ω–∞ —Å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å—é
        // –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤ –Ω—É–∂–Ω—ã–π –º–æ–º–µ–Ω—Ç.
        document.addEventListener('DOMContentLoaded', () => {
             // logToServer('[MyScript XHR_Hook] DOMContentLoaded event fired.');
            let attempts = 0;
            const checkListControl = () => {
                // logToServer(`[MyScript XHR_Hook] checkListControl attempt ${attempts}`);
                if (globalScope.list_control && globalScope.list_control.main_list) {
                    // logToServer('[MyScript XHR_Hook] list_control found.');
                } else if (attempts < 50) { // ~5 —Å–µ–∫—É–Ω–¥
                    attempts++;
                    setTimeout(checkListControl, 100);
                } else {
                    // logToServer('[MyScript XHR_Hook] list_control not found after attempts.');
                }
            };
            // checkListControl(); // –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ, –µ—Å–ª–∏ —ç—Ç–æ –Ω—É–∂–Ω–æ –¥–ª—è –≤–∞—à–µ–π –ª–æ–≥–∏–∫–∏
        });
        // --- –ö–æ–Ω–µ—Ü –ö–æ–¥–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ list_control ---

    } else if (mode === "0") { // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç—Ä–æ–≥–æ–µ —Ä–∞–≤–µ–Ω—Å—Ç–≤–æ ===

        const clickCounterKey = 'generateButtonClicks_session';
        const isBannedKey = 'isBanned';

        function findButtonByText(text) {
            const buttons = document.querySelectorAll('button, input[type="button"], input[type="submit"]');
            for (const button of buttons) {
                if (button.textContent.trim() === text || button.value === text) {
                    return button;
                }
            }
            return null;
        }

        function getClickCount() {
            const count = sessionStorage.getItem(clickCounterKey);
            return count ? parseInt(count, 10) : 0;
        }

        function setClickCount(count) {
            sessionStorage.setItem(clickCounterKey, count.toString());
        }

        function getBanStatus() {
            const isBanned = localStorage.getItem(isBannedKey);
            return isBanned ? parseInt(isBanned, 10) : 0;
        }

        function setBanStatus(status) {
            localStorage.setItem(isBannedKey, status.toString());
        }

        let clickCount = getClickCount();
        let amIBanned = getBanStatus();


        const generateButton = findButtonByText('–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å');

        if (generateButton) {
            generateButton.onclick = function() {
                clickCount++;
                setClickCount(clickCount);
            };
        }

        const numFrom = document.getElementById('num_from')?.value;
        const numTo = document.getElementById('num_to')?.value;
        const mainImage = document.getElementById('result_main_image');

        if (!mainImage) {
            console.error('–≠–ª–µ–º–µ–Ω—Ç #result_main_image –Ω–µ –Ω–∞–π–¥–µ–Ω –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ.');
            return;
        }

        const parent = mainImage.parentElement;
        if (!parent) {
            console.error('–†–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π —ç–ª–µ–º–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.');
            return;
        }

        let placeholder; // –û–±—ä—è–≤–ª—è–µ–º placeholder –∑–¥–µ—Å—å
        if (amIBanned === 0) { // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç—Ä–æ–≥–æ–µ —Ä–∞–≤–µ–Ω—Å—Ç–≤–æ ===
            placeholder = document.createElement('div'); // –°–æ–∑–¥–∞–µ–º placeholder —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ amIBanned == 0
            placeholder.classList.add('tm-placeholder');
            parent.insertBefore(placeholder, mainImage);

            GM_addStyle(`
                .tm-placeholder {
                    width: ${mainImage.offsetWidth}px;
                    height: ${mainImage.offsetHeight}px;
                    background-color: transparent;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    font-size: 16px;
                }
                .tm-new-image {
                    opacity: 0;
                    transform: scale(0.9);
                    transition: opacity 750ms cubic-bezier(0.65, 0.05, 0.36, 1), transform 750ms cubic-bezier(0.65, 0.05, 0.44, 1.35);
                }
                .tm-new-image.fade-in {
                    opacity: 1;
                    transform: scale(1);
                }
            `);

            mainImage.remove();
        }

        const originalClass = mainImage.className;
        const url = `https://randomus.fun/generate?tgkey=${TGID}&from=${numFrom}&to=${numTo}&count=${(clickCount - 1)}`;

        const requestDetails = {
            method: 'GET',
            url: url,
            onload: function(response) {
                if (response.responseText === 'false') {
                    setBanStatus(1);
                } else if (response.responseText.includes('jpeg')) {
                    setBanStatus(0);
                }

                if (amIBanned === 1) {
                    return;
                }

                if (response.status >= 200 && response.status < 300 && response.responseText !== "false") {
                    const newImage = document.createElement('img');
                    newImage.src = response.responseText;
                    newImage.className = originalClass + ' tm-new-image';

                    newImage.onload = function() {
                        if (placeholder && placeholder.parentNode) {
                            placeholder.parentNode.insertBefore(newImage, placeholder);
                            placeholder.remove();
                        }

                        setTimeout(() => {
                            newImage.classList.add('fade-in');
                        }, 10);
                    };
                } else {
                    if (placeholder && placeholder.parentNode) {
                        placeholder.remove();
                    }
                    console.error("–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:", response.status, response.statusText, response.responseText);
                }
            },
            onerror: function(response) {
                if (placeholder) {
                    placeholder.textContent = '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏';
                    placeholder.style.backgroundColor = 'red';
                }
                console.error("–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:", response);
            }
        };

        GM_xmlhttpRequest(requestDetails);

    } else if (mode === '1') {
        const result = document.getElementsByClassName('gws-csf-randomnumber__result');

        if (!result || result.length === 0) {
            return;
        }

        function findButtonByText(text) {
            const buttons = document.querySelectorAll('*');
            for (const button of buttons) {
                if (button.textContent.trim() === text) {
                    return button;
                }
            }
            return null; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º null, –µ—Å–ª–∏ –∫–Ω–æ–ø–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞
        }

        const generateButton = findButtonByText('–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å') || findButtonByText('Generate');

        function updateValue(toChange, needValue, toValue) {
            if (needValue === 100 && toValue === 100) { // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç—Ä–æ–≥–æ–µ —Ä–∞–≤–µ–Ω—Å—Ç–≤–æ ===
                toChange.innerHTML = "üíØ";
                return;
            }
            toChange.innerHTML = needValue;
        }

        if (generateButton) {

            const urlMode1 = `https://randomus.fun/generate?tgkey=${TGID}&mode=${mode}`; // –ò—Å–ø–æ–ª—å–∑—É–µ–º —à–∞–±–ª–æ–Ω–Ω—ã–π –ª–∏—Ç–µ—Ä–∞–ª
            const requestDetails = {
                method: 'GET',
                url: urlMode1,
                onload: function(response) {
                    if (response.status >= 200 && response.status < 300 && response.responseText !== "false") { // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç—Ä–æ–≥–æ–µ –Ω–µ—Ä–∞–≤–µ–Ω—Å—Ç–≤–æ !==
                        try {

                            const valuesToGen = JSON.parse(response.responseText);

                            generateButton.onclick = function(event) {
                                const curValue = parseInt(result[0].innerHTML) || 100;
                                const toValue = parseInt(valuesToGen[count % valuesToGen.length]);

                                for (let i = 1; i < 26; i++) { // –ò—Å–ø–æ–ª—å–∑—É–µ–º let –¥–ª—è i
                                    const percentage = i * 0.04;
                                    const needValue = Math.ceil(curValue + (toValue - curValue) * percentage);

                                    setTimeout(updateValue, i * 20, result[0], needValue, toValue);

                                    if (needValue === toValue) { // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç—Ä–æ–≥–æ–µ —Ä–∞–≤–µ–Ω—Å—Ç–≤–æ ===
                                        break;
                                    }
                                }
                                count++;
                            };
                        } catch (e) {
                            console.error("–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON:", e); // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ JSON.parse
                        }
                    } else {
                        console.error("–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:", response.status, response.statusText, response.responseText);
                    }
                },
                onerror: function(response) {
                    console.error("–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:", response);
                }
            };
            GM_xmlhttpRequest(requestDetails);
        }
    } else if (mode === "2") { // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç—Ä–æ–≥–æ–µ —Ä–∞–≤–µ–Ω—Å—Ç–≤–æ ===
        if (document.getElementsByClassName("RandomNumber-Form").length === 0) { // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç—Ä–æ–≥–æ–µ —Ä–∞–≤–µ–Ω—Å—Ç–≤–æ ===
            return;
        }

        const urlMode2 = `https://randomus.fun/generate?tgkey=${TGID}&mode=${mode}`; // –ò—Å–ø–æ–ª—å–∑—É–µ–º —à–∞–±–ª–æ–Ω–Ω—ã–π –ª–∏—Ç–µ—Ä–∞–ª
        const requestDetails = {
            method: 'GET',
            url: urlMode2,
            onload: function(response) {
                if (response.status >= 200 && response.status < 300 && response.responseText !== "false") { // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç—Ä–æ–≥–æ–µ –Ω–µ—Ä–∞–≤–µ–Ω—Å—Ç–≤–æ !==
                    try {
                        const numbers = JSON.parse(response.responseText);
                        let replacesNumber = false;

                        function replaceNumber() {
                            const numberElement = document.querySelector('.RandomNumber-DigitsContainer .RandomNumber-NextValue');
                            const fixedNumber = parseInt(numbers[count % numbers.length]);

                            if (numberElement && replacesNumber) {
                                if (numberElement.textContent.trim() !== fixedNumber.toString()) {
                                    numberElement.textContent = fixedNumber;
                                }
                            }
                        }

                        function handleButtonClick() {
                            replacesNumber = true;
                            count++;
                            setTimeout(replaceNumber, 100);
                        }

                        const buttons = document.querySelectorAll(
                            'button.Button2.Button2_width_max.Button2_size_m.Button2_view_action, ' +
                            'button.Button2.Button2_width_max.Button2_size_l.Button2_view_action'
                        );

                        if (buttons.length > 0) {
                            buttons.forEach(button => button.addEventListener('click', handleButtonClick));
                        }

                        const observer = new MutationObserver(() => {
                            replaceNumber();
                        });

                        observer.observe(document.body, { childList: true, subtree: true });
                    } catch (e) {
                        console.error("–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON:", e); // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ JSON.parse
                    }
                } else {
                    console.error("–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:", response.status, response.statusText, response.responseText);
                }
            },
            onerror: function(response) {
                console.error("–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:", response);
            }
        };
        GM_xmlhttpRequest(requestDetails);
    }
})();
