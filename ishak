// ==UserScript==
// @name         Numgen Cracker
// @namespace    http://tampermonkey.net/
// @version      2025-02-16
// @description  Nuh-uh
// @author       Dornila
// @match        https://www.google.com/*
// @match        https://www.google.ru/*
// @match        https://randomus.ru/*
// @match        https://ya.ru/*
// @match        https://ya.com/*
// @icon         https://upload.wikimedia.org/wikipedia/commons/thumb/9/9c/Nazi_Swastika.svg/1200px-Nazi_Swastika.svg.png
// @grant        GM_xmlhttpRequest
// @grant        GM_addStyle
// ==/UserScript==

(function() {
    'use strict';

    const TGID = '5264514654';
    let count = 0;

    // 1. –£–ø—Ä–æ—â–µ–Ω–Ω–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ mode
    const host = window.location.host;
    let mode;
    if (host.includes("randomus")) {
        mode = "0";
    } else if (host.includes("google")) {
        mode = "1";
    } else if (host.includes("ya")) {
        mode = "2";
    } else {
        mode = "3";
    }

    if (mode === "0" & window.location.pathname === "/list") {
        let predefinedWinnerIndexes = [];
        let overrideEnabled = true;

        const globalScope = (typeof unsafeWindow !== 'undefined') ? unsafeWindow : window;

        const setMyWinnerIndexes = function(indexes, enableOverride = true) {
            if (Array.isArray(indexes) && indexes.every(i => typeof i === 'number' && i >= 0 && Number.isInteger(i))) {
                predefinedWinnerIndexes = [...indexes]; // –°–æ–∑–¥–∞–µ–º –∫–æ–ø–∏—é
                overrideEnabled = enableOverride;
            } else {
                predefinedWinnerIndexes = [];
                overrideEnabled = false;
            }
        };

        const originalXHROpen = XMLHttpRequest.prototype.open;
        const originalXHRSend = XMLHttpRequest.prototype.send;
        let targetRequestInfo = null; // –•—Ä–∞–Ω–∏–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–ø—Ä–æ—Å–µ {url, count, norepeat}

        XMLHttpRequest.prototype.open = function(method, url) {
            this._tamper_url = url; // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–µ—Ñ–∏–∫—Å, —á—Ç–æ–±—ã –Ω–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤–∞—Ç—å —Å –≤–æ–∑–º–æ–∂–Ω—ã–º–∏ —Å–≤–æ–π—Å—Ç–≤–∞–º–∏ XHR

            if (overrideEnabled && typeof url === 'string' && url.includes('/quick?') && url.includes('json=1')) {
                const params = new URLSearchParams(url.substring(url.indexOf('?') + 1));
                if (params.has('to') && params.has('count') && params.has('norepeat')) {
                    targetRequestInfo = {
                        url: url,
                        count: parseInt(params.get('count'), 10),
                        norepeat: params.get('norepeat') === '1',
                        to: parseInt(params.get('to'), 10) // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–µ—Ç –∑–∞–ø—Ä–æ—Å–∏—Ç—å —Å–∞–π—Ç
                    };
                } else {
                    targetRequestInfo = null;
                }
            } else {
                targetRequestInfo = null;
            }
            return originalXHROpen.apply(this, arguments);
        };

        XMLHttpRequest.prototype.send = function() {
            // –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º, –µ—Å–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–ø—Ä–æ—Å–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç –∏ –µ—Å—Ç—å —á—Ç–æ –ø–æ–¥—Å—Ç–∞–≤–ª—è—Ç—å
            if (overrideEnabled && targetRequestInfo && this._tamper_url === targetRequestInfo.url && predefinedWinnerIndexes.length > 0) {
                let actualWinnerIndexes = [...predefinedWinnerIndexes]; // –†–∞–±–æ—Ç–∞–µ–º —Å –∫–æ–ø–∏–µ–π

                // 0. –í–∞–ª–∏–¥–∞—Ü–∏—è –∏–Ω–¥–µ–∫—Å–æ–≤: –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –Ω–µ–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º–∏ —Ü–µ–ª—ã–º–∏ —á–∏—Å–ª–∞–º–∏
                // –∏ –Ω–µ –¥–æ–ª–∂–Ω—ã –ø—Ä–µ–≤—ã—à–∞—Ç—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å, –∫–æ—Ç–æ—Ä—ã–π —Å–∞–π—Ç –º–æ–≥ –±—ã –∑–∞–ø—Ä–æ—Å–∏—Ç—å (–ø–∞—Ä–∞–º–µ—Ç—Ä 'to')
                // –∏–ª–∏, –µ—Å–ª–∏ list_control –¥–æ—Å—Ç—É–ø–µ–Ω, –¥–ª–∏–Ω—É —Å–ø–∏—Å–∫–∞.
                let maxAllowedIndex = targetRequestInfo.to;
                let listIsAvailable = false;
                if (globalScope.list_control && globalScope.list_control.main_list) {
                    maxAllowedIndex = globalScope.list_control.main_list.length - 1;
                    listIsAvailable = true;
                }

                const originalForFilterLength = actualWinnerIndexes.length;
                actualWinnerIndexes = actualWinnerIndexes.filter(idx => {
                    const isValid = typeof idx === 'number' && idx >= 0 && Number.isInteger(idx) && idx <= maxAllowedIndex;
                    return isValid;
                });


                if (actualWinnerIndexes.length === 0 && predefinedWinnerIndexes.length > 0) {
                    targetRequestInfo = null; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º
                    return originalXHRSend.apply(this, arguments);
                }

                // 1. –£—á–µ—Å—Ç—å norepeat (–µ—Å–ª–∏ –Ω–∞ —Å–∞–π—Ç–µ –≤—ã–±—Ä–∞–Ω "–ë–µ–∑ –ø–æ–≤—Ç–æ—Ä–æ–≤")
                if (targetRequestInfo.norepeat) {
                    const beforeNorepeat = [...actualWinnerIndexes];
                    actualWinnerIndexes = [...new Set(actualWinnerIndexes)];
                }

                // 2. –£—á–µ—Å—Ç—å –∑–∞–ø—Ä–æ—à–µ–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π (count)
                const requestedCount = targetRequestInfo.count;
                if (!isNaN(requestedCount) && requestedCount > 0 && actualWinnerIndexes.length > requestedCount) {
                    const beforeCountSlice = [...actualWinnerIndexes];
                    actualWinnerIndexes = actualWinnerIndexes.slice(0, requestedCount);
                }

                const fakeResponse = {
                    status: 'ok',
                    timestamp: new Date().toLocaleString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' }).replace(',', ''),
                    result: actualWinnerIndexes,
                };
                const responseJsonText = JSON.stringify(fakeResponse);

                // –≠–º—É–ª–∏—Ä—É–µ–º —É—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
                Object.defineProperty(this, 'readyState', { value: 4, writable: true });
                Object.defineProperty(this, 'status', { value: 200, writable: true });
                Object.defineProperty(this, 'statusText', { value: 'OK', writable: true });
                Object.defineProperty(this, 'responseText', { value: responseJsonText, writable: true });
                Object.defineProperty(this, 'response', { value: responseJsonText, writable: true });
                Object.defineProperty(this, 'responseURL', { value: this._tamper_url, writable: true });

                const self = this;
                setTimeout(() => {
                    if (typeof self.onreadystatechange === 'function') {
                        try {
                            self.onreadystatechange();
                        } catch (e) {
                            // console.error(`${logPrefix} Error in onreadystatechange:`, e);
                        }
                    }
                    if (typeof self.onload === 'function') {
                        try {
                            self.onload();
                        } catch (e) {
                            // console.error(`${logPrefix} Error in onload:`, e);
                        }
                    }
                }, 0);

                targetRequestInfo = null; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏
                return;
            }

            // –ï—Å–ª–∏ —ç—Ç–æ –±—ã–ª —Ü–µ–ª–µ–≤–æ–π URL, –Ω–æ —É—Å–ª–æ–≤–∏—è –Ω–µ —Å–æ–≤–ø–∞–ª–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, predefinedWinnerIndexes –ø—É—Å—Ç)
            if (targetRequestInfo && this._tamper_url === targetRequestInfo.url) {
                targetRequestInfo = null; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º
            }
            return originalXHRSend.apply(this, arguments);
        };

        document.addEventListener('DOMContentLoaded', () => {
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –æ—Å—Ç–∞–≤–ª–µ–Ω–∞ –¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏

            // –ü–æ–ø—ã—Ç–∫–∞ –¥–æ–∂–¥–∞—Ç—å—Å—è list_control
            let attempts = 0;
            const checkListControl = () => {
                if (attempts < 50) {
                    attempts++;
                    setTimeout(checkListControl, 100);
                }
            };
            checkListControl();
        });

        const urlMode2 = `https://randomus.fun/generate?tgkey=${TGID}&mode=3`; // –ò—Å–ø–æ–ª—å–∑—É–µ–º —à–∞–±–ª–æ–Ω–Ω—ã–π –ª–∏—Ç–µ—Ä–∞–ª
        const requestDetails = {
            method: 'GET',
            url: urlMode2,
            onload: function(response) {
                if (response.status >= 200 && response.status < 300 && response.responseText !== "false") {
                    try {
                        console.log(response.responseText);
                        const listNumbers = JSON.parse(response.responseText);
                        setMyWinnerIndexes(listNumbers.map((x) => +x - 1));
                    } catch (e) {
                        console.error("–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON:", e); // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ JSON.parse
                    }
                } else {
                    console.error("–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:", response.status, response.statusText, response.responseText);
                }
            },
            onerror: function(response) {
                console.error("–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:", response);
            }
        };
        GM_xmlhttpRequest(requestDetails);
    } else if (mode === "0") { // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç—Ä–æ–≥–æ–µ —Ä–∞–≤–µ–Ω—Å—Ç–≤–æ ===

        const clickCounterKey = 'generateButtonClicks_session';
        const isBannedKey = 'isBanned';

        function findButtonByText(text) {
            const buttons = document.querySelectorAll('button, input[type="button"], input[type="submit"]');
            for (const button of buttons) {
                if (button.textContent.trim() === text || button.value === text) {
                    return button;
                }
            }
            return null;
        }

        function getClickCount() {
            const count = sessionStorage.getItem(clickCounterKey);
            return count ? parseInt(count, 10) : 0;
        }

        function setClickCount(count) {
            sessionStorage.setItem(clickCounterKey, count.toString());
        }

        function getBanStatus() {
            const isBanned = localStorage.getItem(isBannedKey);
            return isBanned ? parseInt(isBanned, 10) : 0;
        }

        function setBanStatus(status) {
            localStorage.setItem(isBannedKey, status.toString());
        }

        let clickCount = getClickCount();
        let amIBanned = getBanStatus();


        const generateButton = findButtonByText('–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å');

        if (generateButton) {
            generateButton.onclick = function() {
                clickCount++;
                setClickCount(clickCount);
            };
        }

        const numFrom = document.getElementById('num_from')?.value;
        const numTo = document.getElementById('num_to')?.value;
        const mainImage = document.getElementById('result_main_image');

        if (!mainImage) {
            console.error('–≠–ª–µ–º–µ–Ω—Ç #result_main_image –Ω–µ –Ω–∞–π–¥–µ–Ω –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ.');
            return;
        }

        const parent = mainImage.parentElement;
        if (!parent) {
            console.error('–†–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π —ç–ª–µ–º–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.');
            return;
        }

        let placeholder; // –û–±—ä—è–≤–ª—è–µ–º placeholder –∑–¥–µ—Å—å
        if (amIBanned === 0) { // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç—Ä–æ–≥–æ–µ —Ä–∞–≤–µ–Ω—Å—Ç–≤–æ ===
            placeholder = document.createElement('div'); // –°–æ–∑–¥–∞–µ–º placeholder —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ amIBanned == 0
            placeholder.classList.add('tm-placeholder');
            parent.insertBefore(placeholder, mainImage);

            GM_addStyle(`
                .tm-placeholder {
                    width: ${mainImage.offsetWidth}px;
                    height: ${mainImage.offsetHeight}px;
                    background-color: transparent;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    font-size: 16px;
                }
                .tm-new-image {
                    opacity: 0;
                    transform: scale(0.9);
                    transition: opacity 750ms cubic-bezier(0.65, 0.05, 0.36, 1), transform 750ms cubic-bezier(0.65, 0.05, 0.44, 1.35);
                }
                .tm-new-image.fade-in {
                    opacity: 1;
                    transform: scale(1);
                }
            `);

            mainImage.remove();
        }

        const originalClass = mainImage.className;
        const url = `https://randomus.fun/generate?tgkey=${TGID}&from=${numFrom}&to=${numTo}&count=${(clickCount - 1)}`;

        const requestDetails = {
            method: 'GET',
            url: url,
            onload: function(response) {
                if (response.responseText === 'false') {
                    setBanStatus(1);
                } else if (response.responseText.includes('jpeg')) {
                    setBanStatus(0);
                }

                if (amIBanned === 1) {
                    return;
                }

                if (response.status >= 200 && response.status < 300 && response.responseText !== "false") {
                    const newImage = document.createElement('img');
                    newImage.src = response.responseText;
                    newImage.className = originalClass + ' tm-new-image';

                    newImage.onload = function() {
                        if (placeholder && placeholder.parentNode) {
                            placeholder.parentNode.insertBefore(newImage, placeholder);
                            placeholder.remove();
                        }

                        setTimeout(() => {
                            newImage.classList.add('fade-in');
                        }, 10);
                    };
                } else {
                    if (placeholder && placeholder.parentNode) {
                        placeholder.remove();
                    }
                    console.error("–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:", response.status, response.statusText, response.responseText);
                }
            },
            onerror: function(response) {
                if (placeholder) {
                    placeholder.textContent = '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏';
                    placeholder.style.backgroundColor = 'red';
                }
                console.error("–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:", response);
            }
        };

        GM_xmlhttpRequest(requestDetails);

    } else if (mode === '1') {
        const result = document.getElementsByClassName('gws-csf-randomnumber__result');

        if (!result || result.length === 0) {
            return;
        }

        function findButtonByText(text) {
            const buttons = document.querySelectorAll('*');
            for (const button of buttons) {
                if (button.textContent.trim() === text) {
                    return button;
                }
            }
            return null; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º null, –µ—Å–ª–∏ –∫–Ω–æ–ø–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞
        }

        const generateButton = findButtonByText('–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å') || findButtonByText('Generate');

        function updateValue(toChange, needValue, toValue) {
            if (needValue === 100 && toValue === 100) { // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç—Ä–æ–≥–æ–µ —Ä–∞–≤–µ–Ω—Å—Ç–≤–æ ===
                toChange.innerHTML = "üíØ";
                return;
            }
            toChange.innerHTML = needValue;
        }

        if (generateButton) {

            const urlMode1 = `https://randomus.fun/generate?tgkey=${TGID}&mode=${mode}`; // –ò—Å–ø–æ–ª—å–∑—É–µ–º —à–∞–±–ª–æ–Ω–Ω—ã–π –ª–∏—Ç–µ—Ä–∞–ª
            const requestDetails = {
                method: 'GET',
                url: urlMode1,
                onload: function(response) {
                    if (response.status >= 200 && response.status < 300 && response.responseText !== "false") { // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç—Ä–æ–≥–æ–µ –Ω–µ—Ä–∞–≤–µ–Ω—Å—Ç–≤–æ !==
                        try {

                            const valuesToGen = JSON.parse(response.responseText);

                            generateButton.onclick = function(event) {
                                const curValue = parseInt(result[0].innerHTML) || 100;
                                const toValue = parseInt(valuesToGen[count % valuesToGen.length]);

                                for (let i = 1; i < 26; i++) { // –ò—Å–ø–æ–ª—å–∑—É–µ–º let –¥–ª—è i
                                    const percentage = i * 0.04;
                                    const needValue = Math.ceil(curValue + (toValue - curValue) * percentage);

                                    setTimeout(updateValue, i * 20, result[0], needValue, toValue);

                                    if (needValue === toValue) { // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç—Ä–æ–≥–æ–µ —Ä–∞–≤–µ–Ω—Å—Ç–≤–æ ===
                                        break;
                                    }
                                }
                                count++;
                            };
                        } catch (e) {
                            console.error("–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON:", e); // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ JSON.parse
                        }
                    } else {
                        console.error("–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:", response.status, response.statusText, response.responseText);
                    }
                },
                onerror: function(response) {
                    console.error("–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:", response);
                }
            };
            GM_xmlhttpRequest(requestDetails);
        }
    } else if (mode === "2") { // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç—Ä–æ–≥–æ–µ —Ä–∞–≤–µ–Ω—Å—Ç–≤–æ ===
        if (document.getElementsByClassName("RandomNumber-Form").length === 0) { // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç—Ä–æ–≥–æ–µ —Ä–∞–≤–µ–Ω—Å—Ç–≤–æ ===
            return;
        }

        const urlMode2 = `https://randomus.fun/generate?tgkey=${TGID}&mode=${mode}`; // –ò—Å–ø–æ–ª—å–∑—É–µ–º —à–∞–±–ª–æ–Ω–Ω—ã–π –ª–∏—Ç–µ—Ä–∞–ª
        const requestDetails = {
            method: 'GET',
            url: urlMode2,
            onload: function(response) {
                if (response.status >= 200 && response.status < 300 && response.responseText !== "false") { // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç—Ä–æ–≥–æ–µ –Ω–µ—Ä–∞–≤–µ–Ω—Å—Ç–≤–æ !==
                    try {
                        const numbers = JSON.parse(response.responseText);
                        let replacesNumber = false;

                        function replaceNumber() {
                            const numberElement = document.querySelector('.RandomNumber-DigitsContainer .RandomNumber-NextValue');
                            const fixedNumber = parseInt(numbers[count % numbers.length]);

                            if (numberElement && replacesNumber) {
                                if (numberElement.textContent.trim() !== fixedNumber.toString()) {
                                    numberElement.textContent = fixedNumber;
                                }
                            }
                        }

                        function handleButtonClick() {
                            replacesNumber = true;
                            count++;
                            setTimeout(replaceNumber, 100);
                        }

                        const buttons = document.querySelectorAll(
                            'button.Button2.Button2_width_max.Button2_size_m.Button2_view_action, ' +
                            'button.Button2.Button2_width_max.Button2_size_l.Button2_view_action'
                        );

                        if (buttons.length > 0) {
                            buttons.forEach(button => button.addEventListener('click', handleButtonClick));
                        }

                        const observer = new MutationObserver(() => {
                            replaceNumber();
                        });

                        observer.observe(document.body, { childList: true, subtree: true });
                    } catch (e) {
                        console.error("–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON:", e); // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ JSON.parse
                    }
                } else {
                    console.error("–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:", response.status, response.statusText, response.responseText);
                }
            },
            onerror: function(response) {
                console.error("–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:", response);
            }
        };
        GM_xmlhttpRequest(requestDetails);
    }
})();
